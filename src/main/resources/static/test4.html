<!doctype html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Game</title>
    <style>
        body{margin:0;background:#0b0b0b;color:#fff;font-family:Arial,"Microsoft YaHei",sans-serif;}

        /* 右上角登录框 */
        .top-right-form{
            position:fixed;top:12px;right:12px;
            display:flex;align-items:center;gap:6px;
            padding:10px;background:#121212;
            border:1px solid rgba(255,255,255,.15);
            border-radius:12px;z-index:999;
        }
        .top-right-form input{
            width:92px;padding:6px 8px;border-radius:8px;
            border:1px solid rgba(255,255,255,.25);
            background:rgba(255,255,255,.05);
            color:#fff;font-size:12px;outline:none;
        }
        .top-right-form button{
            width:58px;height:28px;border-radius:8px;
            border:1px solid rgba(255,255,255,.25);
            background:#fff;color:#111;font-weight:800;font-size:12px;cursor:pointer;
        }
        .top-right-form button.secondary{background:transparent;color:#fff;}
        .mini-tip{font-size:12px;margin-left:6px;}
        .mini-tip.ok{color:#9efc9e;}
        .mini-tip.bad{color:#ffb3b3;}

        /* 左上角玩家信息块 */
        .player-panel{
            position:fixed;
            top:12px;
            left:12px;
            width:160px;
            padding:10px 12px;
            background:#121212;
            border:1px solid rgba(255,255,255,.15);
            border-radius:12px;
            font-size:12px;
            line-height:1.7;
            z-index:998;
            display:none;
        }
        .player-panel b{font-size:13px;color:#fff;}

        /* 技能按钮（左侧，玩家信息块下方） */
        .skill-btn{
            position:fixed;
            top:190px;
            left:12px;
            width:184px;
            padding:10px 12px;
            background:#121212;
            border:1px solid rgba(255,255,255,.15);
            border-radius:12px;
            z-index:998;
            display:none;
            box-sizing:border-box;
        }
        .skill-btn button{
            width:100%;
            height:32px;
            border-radius:10px;
            border:1px solid rgba(255,255,255,.25);
            background:#fff;
            color:#111;
            font-weight:900;
            font-size:12px;
            cursor:pointer;
        }

        /* 技能弹层 */
        .modal{
            position:fixed;
            inset:0;
            background:rgba(0,0,0,.6);
            display:none;
            align-items:center;
            justify-content:center;
            z-index:1000;
            padding:20px;
            box-sizing:border-box;
        }
        .modal .card{
            width:min(920px, 96vw);
            background:#121212;
            border:1px solid rgba(255,255,255,.15);
            border-radius:16px;
            box-shadow:0 20px 60px rgba(0,0,0,.55);
            overflow:hidden;
        }
        .modal .head{
            display:flex;
            align-items:center;
            justify-content:space-between;
            gap:10px;
            padding:12px 14px;
            border-bottom:1px solid rgba(255,255,255,.12);
        }
        .modal .title{
            font-weight:900;
            font-size:14px;
            letter-spacing:.5px;
        }
        .modal .tabs{
            display:flex;
            gap:8px;
            align-items:center;
            justify-content:flex-end;
            flex-wrap:wrap;
        }
        .tab-btn{
            height:28px;
            padding:0 10px;
            border-radius:10px;
            border:1px solid rgba(255,255,255,.25);
            background:transparent;
            color:#fff;
            font-weight:800;
            font-size:12px;
            cursor:pointer;
            opacity:.9;
        }
        .tab-btn.active{
            background:#fff;
            color:#111;
            opacity:1;
        }
        .close-btn{
            height:28px;
            padding:0 10px;
            border-radius:10px;
            border:1px solid rgba(255,255,255,.25);
            background:transparent;
            color:#fff;
            font-weight:800;
            font-size:12px;
            cursor:pointer;
        }

        .modal .body{
            padding:12px 14px 14px;
        }

        /* 表格 */
        table{
            width:100%;
            border-collapse:collapse;
            table-layout:fixed;
            font-size:12px;
        }
        th, td{
            border:1px solid rgba(255,255,255,.12);
            padding:8px 10px;
            text-align:center;
            word-break:break-all;
        }
        thead th{
            background:rgba(255,255,255,.06);
            font-weight:900;
        }
        tbody tr:hover{
            background:rgba(255,255,255,.04);
        }

        /* 神技：小一点 */
        .small table{font-size:11px;}
        .small th,.small td{padding:6px 8px;}

        .hint{
            margin-top:10px;
            font-size:12px;
            opacity:.85;
            line-height:1.6;
        }
        .hint code{
            background:rgba(255,255,255,.08);
            padding:2px 6px;
            border-radius:8px;
            border:1px solid rgba(255,255,255,.12);
        }
    </style>
</head>
<body>

<!-- 左上角玩家信息 -->
<div class="player-panel" id="playerPanel"></div>

<!-- 技能按钮（登录后显示） -->
<div class="skill-btn" id="skillBtnWrap">
    <button id="openSkillBtn">技能</button>
</div>

<!-- 右上角登录注册 -->
<div class="top-right-form">
    <input id="userName" placeholder="用户名">
    <input id="password" type="password" placeholder="密码">
    <button id="registerBtn">注册</button>
    <button id="loginBtn" class="secondary">登录</button>
    <span class="mini-tip" id="tip"></span>
</div>

<!-- 技能弹层 -->
<div class="modal" id="skillModal">
    <div class="card">
        <div class="head">
            <div class="title" id="modalTitle">技能</div>
            <div class="tabs">
                <button class="tab-btn active" id="tabNormal">技能(1/3/4)</button>
                <button class="tab-btn" id="tabGod">神技(2)</button>
                <button class="close-btn" id="closeModal">关闭</button>
            </div>
        </div>
        <div class="body" id="modalBody">
            <!-- 表格会渲染到这里 -->
        </div>
    </div>
</div>

<script>
    const API = {
        register: "/players/register",
        login: "/players/login",
        showSkill: "/players/skill/show"
    };

    const $ = (id) => document.getElementById(id);

    function setTip(msg, ok){
        const tip = $("tip");
        tip.textContent = msg || "";
        tip.className = "mini-tip " + (ok ? "ok" : "bad");
    }

    function renderPlayer(p){
        const box = $("playerPanel");
        const skillWrap = $("skillBtnWrap");
        if(!p){
            box.style.display="none";
            skillWrap.style.display="none";
            return;
        }
        box.style.display="block";
        skillWrap.style.display="block";
        box.innerHTML =
            `<b>${p.userName}</b><br>` +
            `Lv: ${p.lv}<br>` +
            `HP: ${p.hp}<br>` +
            `MP: ${p.mp}<br>` +
            `Money: ${p.money}<br>` +
            `Exp: ${p.exp} / ${p.expMax}`;
    }

    async function postJson(url,data){
        const res = await fetch(url,{
            method:"POST",
            headers:{ "Content-Type":"application/json" },
            body:JSON.stringify(data)
        });
        return await res.json();
    }

    function getPlayerCache(){
        return JSON.parse(localStorage.getItem("player") || "null");
    }

    function setPlayerCache(p){
        localStorage.setItem("player", JSON.stringify(p));
    }

    function openModal(){
        $("skillModal").style.display="flex";
    }
    function closeModal(){
        $("skillModal").style.display="none";
    }
    $("closeModal").onclick = closeModal;
    $("skillModal").addEventListener("click", (e)=>{
        if(e.target === $("skillModal")) closeModal();
    });

    // 统一把 type 变成数字（后端可能返回字符串）
    function toNum(x){
        const n = Number(x);
        return Number.isFinite(n) ? n : null;
    }

    // 过滤 type：技能(1/3/4) or 神技(2)
    function filterSkillsByMode(list, mode){
        if(!Array.isArray(list)) return [];
        if(mode === "god"){
            return list.filter(s => toNum(s.type) === 2);
        }
        return list.filter(s => [1,3,4].includes(toNum(s.type)));
    }

    // 渲染：技能(1/3/4) 需要显示 limitedLv
    function renderSkillTableNormal(list){
        const rows = list.map(s => {
            const name = s.skillName ?? "";
            const limitedLv = s.limitedLv ?? "";
            const lv = s.lv ?? "";
            const curATK = s.curATK ?? "";
            const curMpCost = s.curMpCost ?? "";
            const curUpgradeCost = s.curUpgradeCost ?? "";
            return `
        <tr>
          <td>${name}</td>
          <td>${limitedLv}</td>
          <td>${lv}</td>
          <td>${curATK}</td>
          <td>${curMpCost}</td>
          <td>${curUpgradeCost}</td>
        </tr>
      `;
        }).join("");

        return `
      <table>
        <thead>
          <tr>
            <th style="width:22%">name</th>
            <th style="width:14%">limitedlv</th>
            <th style="width:10%">lv</th>
            <th style="width:14%">curatk</th>
            <th style="width:20%">curmpcost</th>
            <th style="width:20%">curupgradecost</th>
          </tr>
        </thead>
        <tbody>
          ${rows || `<tr><td colspan="6" style="opacity:.8">暂无数据</td></tr>`}
        </tbody>
      </table>
    `;
    }

    // 渲染：神技(2) 不展示 limitedLv，整体小一点
    function renderSkillTableGod(list){
        const rows = list.map(s => {
            const name = s.skillName ?? "";
            const lv = s.lv ?? "";
            const curATK = s.curATK ?? "";
            const curMpCost = s.curMpCost ?? "";
            const curUpgradeCost = s.curUpgradeCost ?? "";
            return `
        <tr>
          <td>${name}</td>
          <td>${lv}</td>
          <td>${curATK}</td>
          <td>${curMpCost}</td>
          <td>${curUpgradeCost}</td>
        </tr>
      `;
        }).join("");

        return `
      <div class="small">
        <table>
          <thead>
            <tr>
              <th style="width:26%">name</th>
              <th style="width:10%">lv</th>
              <th style="width:16%">curatk</th>
              <th style="width:24%">curmpcost</th>
              <th style="width:24%">curupgradecost</th>
            </tr>
          </thead>
          <tbody>
            ${rows || `<tr><td colspan="5" style="opacity:.8">暂无数据</td></tr>`}
          </tbody>
        </table>
      </div>
    `;
    }

    // 拉取技能数据（后端返回 List<PlayerSkill>）
    async function fetchSkills(playerId){
        const r = await postJson(API.showSkill, { playerId });
        if(r && r.code === 1){
            return Array.isArray(r.data) ? r.data : [];
        }
        throw new Error((r && r.msg) ? r.msg : "查询失败");
    }

    // 当前模式：normal 或 god
    let currentMode = "normal";
    let lastSkillsCache = null; // 缓存一次请求结果

    function setTabActive(){
        const tn = $("tabNormal");
        const tg = $("tabGod");
        if(currentMode === "god"){
            tg.classList.add("active");
            tn.classList.remove("active");
            $("modalTitle").textContent = "神技";
        }else{
            tn.classList.add("active");
            tg.classList.remove("active");
            $("modalTitle").textContent = "技能";
        }
    }

    function renderSkillsIntoModal(){
        const all = lastSkillsCache || [];
        if(currentMode === "god"){
            const list = filterSkillsByMode(all, "god");
            $("modalBody").innerHTML = renderSkillTableGod(list);
        }else{
            const list = filterSkillsByMode(all, "normal");
            $("modalBody").innerHTML = renderSkillTableNormal(list);
        }
        setTabActive();
    }

    $("tabNormal").onclick = ()=>{
        currentMode = "normal";
        renderSkillsIntoModal();
    };
    $("tabGod").onclick = ()=>{
        currentMode = "god";
        renderSkillsIntoModal();
    };

    // 打开技能弹窗：查询一次并渲染
    $("openSkillBtn").onclick = async ()=>{
        const p = getPlayerCache();
        if(!p || !p.id){
            setTip("请先登录", false);
            return;
        }

        setTip("", true);
        $("modalBody").innerHTML = `<div class="hint">加载中...</div>`;
        openModal();

        try{
            // 每次打开都重新拉一次，保证“实时计算”的数据是新的
            lastSkillsCache = await fetchSkills(p.id);
            renderSkillsIntoModal();
        }catch(err){
            $("modalBody").innerHTML = `<div class="hint">加载失败：<code>${String(err.message || err)}</code></div>`;
        }
    };

    /* 注册 */
    $("registerBtn").onclick = async ()=>{
        const userName=$("userName").value.trim();
        const password=$("password").value;
        if(!userName||!password){ setTip("不能为空",false); return; }
        const r=await postJson(API.register,{userName,password});
        if(r.code===1) setTip("注册成功",true);
        else setTip(r.msg,false);
    };

    /* 登录 */
    $("loginBtn").onclick = async ()=>{
        const userName=$("userName").value.trim();
        const password=$("password").value;
        if(!userName||!password){ setTip("不能为空",false); return; }

        const r=await postJson(API.login,{userName,password});
        if(r.code===1){
            setTip("登录成功",true);
            renderPlayer(r.data);
            setPlayerCache(r.data);
        }else{
            setTip(r.msg,false);
            renderPlayer(null);
            localStorage.removeItem("player");
        }
    };

    /* 刷新恢复显示 */
    const cache = getPlayerCache();
    if(cache) renderPlayer(cache);
</script>

</body>
</html>
